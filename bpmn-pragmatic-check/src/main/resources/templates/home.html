<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pragmatic Quality Check</title>
    <style>
        * {
            font-family: 'IBM Plex Sans', sans-serif;
        }
        .collapsible {
            color: white;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            text-align: left;
            outline: none;
            border: none;
            border-radius: 9px;
            font-size: 15px;
        }

        .score {
            float: right;
            font-weight: bold;
            font-size: 20px;
            padding-right: 18px;
        }

        .active, .collapsible:hover {
            background-color: #E6E7E8;
        }

        .content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border: none;
            border-radius: 9px;
            background-color: #f1f1f1;
        }
        .flexbox-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .flexbox-column {
            display: flex;
            flex-direction: column;
        }

        .container {
            margin: 25px 50px;
        }

        .nested {
            margin: 10px 10px;
        }

        .bpmn-container {
            border: 1px;
            border-radius: 12px;
        }

        .auto-width {
            width: auto;
        }

        h1 {
            padding: 5px;
        }

        #canvas {
            height: 100%;
            border: 1px solid rgba(230, 231, 233, 1);
            border-radius: 9px;
        }

        #error-message{
            color: #FF4700;
            display: flex;
            justify-content: center;
        }

        .process-name {
            padding-left: 18px;
        }

        hr.solid {
            border-top: 3px solid #bbb;
            margin-top: 18px;
        }

    </style>
</head>
<body>
<iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe>
<div class="flexbox-row">
    <div class="flexbox-item"></div>
    <div class="flexbox-item">
        <h1>BPMN Pragmatic Check</h1>
    </div>
    <div class="flexbox-item">
        <a href="https://github.com/ManuelDittmar/master-thesis">Github</a>
    </div>
</div>
<div class="container introduction">
    <p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et
        dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet
        clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet,
        consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed
        diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea .</p>
</div>
<div class="container flexbox-row">
    <form id="analyze" method="post" target="dummyframe" enctype="multipart/form-data">
        <div class="form-group">
            <input type="file" name="file" class="form-control-file">
        </div>
        <button type="submit" class="btn btn-primary">Upload File</button>
    </form>
</div>
<div style="height: 300px;" class="container bpmn-container">
    <div id="canvas"></div>
</div>
<div id="error-message"></div>
<div class="element"></div>
<template id="process-template">
    <div class="flexbox-column container">
        <div class="bpmn-container auto-width">
            <h1 class="process-name"></h1>
            <div class="criterias">
            </div>
            <hr class="solid">
        </div>
    </div>
</template>
<template id="criteria-template">
    <div class="flexbox-column bpmn-container auto-width nested">
        <button class="collapsible" onclick="showContent(event)">
            <span class="criteria-id"></span>
            <span class="score"></span>
        </button>
        <div class="content">
            <div class="outlier">
                <ul class="outlier-list"></ul>
            </div>
        </div>
    </div>
</template>
<template id="outlier-template">
    <li>
        <div class="outlier-name"></div>
        <ul class="outlier-reasons"></ul>
    </li>
</template>
<script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
<script src="https://unpkg.com/bpmn-js@8.8.3/dist/bpmn-navigated-viewer.development.js"></script>
<script>

    class ProcessSummary extends HTMLElement {
        constructor(process) {
            super();
            const templateContent = document
                .getElementById('process-template')
                .content
                .cloneNode(true);
            this.appendChild(templateContent);
            this.querySelector('.process-name').innerHTML = process.processKey;
            process.qualityCriteriaList.forEach(criteria => {
                this.querySelector('.criterias').append(new QualityCriteria(criteria));
            })
        }
    }

    class DiagramSummary extends HTMLElement {
        constructor(criteriaList) {
            super();
            const templateContent = document
                .getElementById('process-template')
                .content
                .cloneNode(true);
            this.appendChild(templateContent);
            this.querySelector('.process-name').innerHTML = "Diagram Criteria";
            criteriaList.forEach(criteria => {
                this.querySelector('.criterias').append(new QualityCriteria(criteria));
            })
        }
    }

    class QualityCriteria extends HTMLElement {
        constructor(criteria) {
            super();
            const templateContent = document
                .getElementById('criteria-template')
                .content
                .cloneNode(true);
            var score = criteria.score;
            var color = "#14d890";
            if(score < 0.8 && score > 0.5) {
                color = "#FF8B00";
            }
            if(score < 0.5 || (score < 1.0 && criteria.criteriaType=="MANDATORY" )) {
                color = "#FF4700";
            }
            this.appendChild(templateContent);
            this.querySelector('.collapsible').style.backgroundColor = color;
            var label = criteria.criteriaID + " (" + criteria.criteriaType + ")";
            this.querySelector('.criteria-id').innerHTML = label;
            this.querySelector('.score').innerHTML = parseFloat(score).toFixed(2);
            if(criteria.outliers.length > 0) {
                criteria.outliers.forEach(outlier=> {
                    this.querySelector('.outlier-list').append(new Outlier(outlier));
                })
            }
        }
    }

    class Outlier extends HTMLElement {
        constructor(outlier) {
            super();
            const templateContent = document
                .getElementById('outlier-template')
                .content
                .cloneNode(true);
            this.appendChild(templateContent);
            if (outlier.id != null) {
                this.querySelector('.outlier-name').innerHTML = outlier.id;
                outlier.reasons.forEach(reason => {
                    var li = document.createElement("li");
                    li.append(document.createTextNode(reason));
                    this.querySelector('.outlier-reasons').append(li);
                })
            }
            else {
                this.querySelector('.outlier-name').innerHTML = outlier;
            }
        }
    }

    customElements.define('process-element', ProcessSummary);
    customElements.define('diagram-element', DiagramSummary);
    customElements.define('criteria-element', QualityCriteria);
    customElements.define('outlier-element', Outlier);

    $('#analyze').submit(function (e) {
        e.preventDefault();
        $.ajax({
            url: '/analyze',
            type: 'post',
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: async function (result) {
                await openDiagram(await this.data.get('file').text())
                $(".element").empty();
                $("#error-message").empty();
                $("#canvas").css({"border":"1px solid rgba(230, 231, 233, 1)"});

                if(result.mandatoryCriteriaNotMet) {
                    $("#canvas").css({"border":"5px solid #FF4700"});
                    $("#error-message").html("<h3> Diagram violates Mandatory Quality Criteria! </h3>")
                }
                if(result.diagramQualityCriteriaList.length > 0) {
                    $(".element").append(new DiagramSummary(result.diagramQualityCriteriaList));
                };
                console.log(result);
                $.each(result.processAnalysisList, function (index, process) {
                    if(process.executable) {
                        $(".element").append(new ProcessSummary(process));
                    }
                });
                console.log(result.processAnalysisList);
            }
        });
    });

    var diagramUrl = 'ApplicationProcess.bpmn';

    // viewer instance
    var bpmnViewer = new BpmnJS({
        container: '#canvas'
    });

    async function openDiagram(bpmnXML) {

        // import diagram
        try {
            await bpmnViewer.importXML(bpmnXML);

            // access viewer components
            var canvas = bpmnViewer.get('canvas');
            // zoom to fit full viewport
            canvas.zoom('fit-viewport');

        } catch (err) {

            console.error('could not import BPMN 2.0 diagram', err);
        }
    }

    $.get(diagramUrl, openDiagram, 'text');

    function showContent(e) {
        e.target.classList.toggle("active");
        var content = e.target.nextElementSibling;
        if (content.style.maxHeight){
            content.style.maxHeight = null;
        } else {
            content.style.maxHeight = content.scrollHeight + "px";
        }
    }
</script>
</body>
</html>